graph TB
    subgraph "Desktop Client Layer"
        HD[holodeck-desktop<br/>Tauri V2 + React<br/>Enterprise Star Trek Theme<br/>MCP Consumer]
    end
    
    subgraph "Orchestration Layer"
        HC[holodeck-coordinator<br/>MCP Client + Orchestrator<br/>Port: 8447<br/>Transport: HybridTransportClient]
        HS[holodeck-storybook<br/>Story/History Server<br/>Port: 8080<br/>Protocol: WebSocket + REST]
    end
    
    subgraph "MCP Server Layer"
        HDE[holodeck-designer<br/>Story Generation<br/>Port: 8443<br/>MCP Server + rig-core + OpenAI]
        HV[holodeck-validator<br/>Story Validation<br/>Port: 8444<br/>MCP Server + JSON Schema]
        HE[holodeck-environment<br/>Environment Generation<br/>Port: 8445<br/>MCP Server + rig-core + OpenAI]
        HSA[holodeck-safety<br/>Safety Monitoring<br/>Port: 8446<br/>MCP Server + Content Safety]
        HCH[holodeck-character<br/>Character AI<br/>Port: 8448<br/>MCP Server + rig-core + Characters]
    end
    
    subgraph "External Services"
        OPENAI[OpenAI GPT-4<br/>LLM Provider]
        NATS[NATS Server<br/>Port: 4222<br/>Message Bus]
    end

    %% Desktop to Coordinator Communication
    HD -->|MCP over Internal Transport| HC
    HD -.->|WebSocket Connection<br/>Real-time Updates| HS
    
    %% Coordinator to MCP Servers (Envelope-First)
    HC -->|MCP + Qollective Envelope<br/>Story Generation Requests| HDE
    HC -->|MCP + Qollective Envelope<br/>Validation Requests| HV
    HC -->|MCP + Qollective Envelope<br/>Environment Requests| HE
    HC -->|MCP + Qollective Envelope<br/>Safety Monitoring| HSA
    HC -->|MCP + Qollective Envelope<br/>Character Requests| HCH
    
    %% Coordinator to Storybook Communication
    HC -->|REST API<br/>Story State Management| HS
    HS -->|WebSocket Events<br/>State Change Notifications| HC
    
    %% MCP Server to LLM Integration
    HDE -->|rig-core Agent Calls| OPENAI
    HE -->|rig-core Agent Calls| OPENAI
    HCH -->|rig-core Agent Calls| OPENAI
    
    %% Cross-Server Validation
    HDE -.->|Validation Request| HV
    HE -.->|Safety Check| HSA
    HCH -.->|Safety Check| HSA
    
    %% NATS Transport Layer (Optional)
    HC -.->|NATS Transport<br/>qollective.mcp.v1.*| NATS
    HDE -.->|NATS Transport| NATS
    HV -.->|NATS Transport| NATS
    HE -.->|NATS Transport| NATS
    HSA -.->|NATS Transport| NATS
    HCH -.->|NATS Transport| NATS
    
    %% Component Details
    classDef desktop fill:#1f4e79,stroke:#ffffff,stroke-width:2px,color:#ffffff
    classDef coordinator fill:#d35400,stroke:#ffffff,stroke-width:2px,color:#ffffff
    classDef mcpServer fill:#27ae60,stroke:#ffffff,stroke-width:2px,color:#ffffff
    classDef storage fill:#8e44ad,stroke:#ffffff,stroke-width:2px,color:#ffffff
    classDef external fill:#34495e,stroke:#ffffff,stroke-width:2px,color:#ffffff
    
    class HD desktop
    class HC coordinator
    class HS storage
    class HDE,HV,HE,HSA,HCH mcpServer
    class OPENAI,NATS external