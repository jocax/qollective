%%{init: {
  'theme': 'dark',
  'themeVariables': {
    'primaryColor': '#82ca9d',
    'primaryTextColor': '#ffffff',
    'primaryBorderColor': '#82ca9d',
    'lineColor': '#8dd3c7',
    'secondaryColor': '#006100',
    'tertiaryColor': '#333333',
    'background': '#1a1a1a',
    'mainBkg': '#1a1a1a',
    'secondBkg': '#2d2d2d',
    'tertiaryBkg': '#404040'
  }
}}%%

sequenceDiagram
    participant LogAgent as ğŸ“± Log Agent<br/>(Client)
    participant A2AClient as ğŸ”— A2A Client<br/>(qollective-a2a-client)
    participant NATS as âš¡ NATS Server<br/>(localhost:4443/TLS)
    participant Enterprise as ğŸ¢ Enterprise Server<br/>(A2A Server)
    participant Registry as ğŸ“‹ Agent Registry<br/>(In-Memory)
    participant RegHandler as ğŸ¯ Registration Handler
    participant HealthMon as ğŸ’— Health Monitor

    %% Agent Registration Flow
    rect rgb(26, 26, 26)
        note over LogAgent, HealthMon: ğŸ”„ Agent Registration Process
        
        LogAgent->>LogAgent: Initialize Log Agent<br/>ğŸ“ Name: "log-agent"<br/>ğŸ†” ID: UUID
        LogAgent->>A2AClient: create_a2a_client(config)<br/>ğŸ”§ NATS URLs: ["nats://localhost:4443"]<br/>ğŸ”’ TLS: enabled
        
        A2AClient->>NATS: Connect to NATS<br/>ğŸ“¡ Subject: "qollective.a2a.v1.register"<br/>ğŸ” Auth: TLS Client Cert
        NATS-->>A2AClient: âœ… Connection Established
        
        LogAgent->>LogAgent: Prepare AgentRegistration<br/>ğŸ“‹ Capabilities: ["log_processing", "file_analysis"]<br/>ğŸ’¾ Metadata: version, build_info
        
        LogAgent->>A2AClient: register_agent(agent_info, metadata)
        
        A2AClient->>A2AClient: ğŸ“¦ Create AgentRegistration envelope<br/>ğŸ·ï¸ Meta: request_id, timestamp
        
        A2AClient->>NATS: publish(subjects::AGENT_REGISTRATION,<br/>AgentRegistration)
        note right of NATS: ğŸ“ Subject: "qollective.a2a.v1.register"<br/>ğŸ’Œ Payload: AgentRegistration<br/>â±ï¸ Timeout: 30s
        
        NATS->>Enterprise: Forward registration message
        Enterprise->>RegHandler: delegate_to_handler(AgentRegistration)
        
        RegHandler->>RegHandler: ğŸ” Validate agent info<br/>âœ“ Name not empty<br/>âœ“ Capabilities < max limit<br/>âœ“ At least one capability
        
        RegHandler->>Registry: register_agent(agent_info, metadata)
        Registry->>Registry: ğŸ’¾ Store agent in memory<br/>ğŸ” Index by ID and capabilities<br/>ğŸ“Š Update statistics
        Registry-->>RegHandler: âœ… Registration successful
        
        RegHandler->>A2AClient: announce_agent(agent_info)
        A2AClient->>NATS: publish(subjects::AGENT_REGISTRY_ANNOUNCE,<br/>AgentInfo)
        note right of NATS: ğŸ“ Subject: "qollective.a2a.v1.registry.announce"<br/>ğŸ“¢ Broadcast: Agent available
        
        RegHandler->>A2AClient: publish_registry_event_to_subject(<br/>"agent_registered", agent_id)
        A2AClient->>NATS: publish(subjects::AGENT_REGISTRY_EVENTS,<br/>RegistryEvent)
        note right of NATS: ğŸ“ Subject: "qollective.a2a.v1.registry.events"<br/>ğŸ‰ Event: agent_registered
        
        RegHandler-->>Enterprise: âœ… RegistrationResponse(success: true)
        Enterprise->>NATS: reply(RegistrationResponse)
        NATS->>A2AClient: receive_response()
        A2AClient-->>LogAgent: âœ… Registration completed
        
        LogAgent->>LogAgent: ğŸ“ Log registration success<br/>ğŸ” Debug: agent details, capabilities<br/>ğŸ“Š NATS subjects used
    end

    %% Health Monitoring
    rect rgb(26, 26, 26)
        note over LogAgent, HealthMon: ğŸ’— Health Monitoring & Heartbeat
        
        loop Every 30 seconds
            LogAgent->>A2AClient: send_heartbeat(agent_id)
            A2AClient->>NATS: publish(subjects::AGENT_HEARTBEAT,<br/>Heartbeat)
            note right of NATS: ğŸ“ Subject: "qollective.a2a.v1.heartbeat"<br/>ğŸ’“ Status: Healthy<br/>â° Timestamp: now()
            
            NATS->>Enterprise: Forward heartbeat
            Enterprise->>HealthMon: update_health(agent_id, status)
            HealthMon->>Registry: update_agent_health(agent_id, Healthy)
            Registry-->>HealthMon: âœ… Health updated
        end
    end

    %% Agent Deregistration Flow
    rect rgb(26, 26, 26)
        note over LogAgent, HealthMon: ğŸ”„ Agent Deregistration Process
        
        LogAgent->>LogAgent: ğŸ›‘ Shutdown signal received<br/>ğŸ§¹ Cleanup resources
        
        LogAgent->>A2AClient: deregister_agent(agent_id)
        
        A2AClient->>A2AClient: ğŸ“¦ Create DeregistrationRequest<br/>ğŸ†” Agent ID<br/>ğŸ“ Reason: "Graceful shutdown"
        
        A2AClient->>NATS: publish(subjects::AGENT_DEREGISTRATION,<br/>DeregistrationRequest)
        note right of NATS: ğŸ“ Subject: "qollective.a2a.v1.deregister"<br/>ğŸ’Œ Payload: DeregistrationRequest<br/>ğŸ“ Reason: shutdown
        
        NATS->>Enterprise: Forward deregistration
        Enterprise->>RegHandler: handle_deregistration(request)
        
        RegHandler->>Registry: get_agent_by_id(agent_id)
        Registry-->>RegHandler: ğŸ“‹ AgentInfo (if exists)
        
        RegHandler->>Registry: deregister_agent(agent_id)
        Registry->>Registry: ğŸ—‘ï¸ Remove from memory<br/>ğŸ” Remove from indices<br/>ğŸ“Š Update statistics
        Registry-->>RegHandler: âœ… Deregistration successful
        
        RegHandler->>A2AClient: deregister_agent(agent_id)
        A2AClient->>NATS: publish(subjects::AGENT_REGISTRY_ANNOUNCE,<br/>DeregistrationEvent)
        note right of NATS: ğŸ“ Subject: "qollective.a2a.v1.registry.announce"<br/>ğŸ“¢ Broadcast: Agent unavailable
        
        RegHandler->>A2AClient: publish_registry_event_to_subject(<br/>"agent_deregistered", agent_id)
        A2AClient->>NATS: publish(subjects::AGENT_REGISTRY_EVENTS,<br/>RegistryEvent)
        note right of NATS: ğŸ“ Subject: "qollective.a2a.v1.registry.events"<br/>ğŸ‘‹ Event: agent_deregistered
        
        RegHandler-->>Enterprise: âœ… Deregistration completed
        Enterprise->>NATS: reply(success)
        NATS->>A2AClient: receive_confirmation()
        A2AClient-->>LogAgent: âœ… Deregistration completed
        
        LogAgent->>LogAgent: ğŸ“ Log deregistration success<br/>ğŸ›‘ Shutdown gracefully
    end

    %% NATS Configuration Details
    rect rgb(26, 26, 26)
        note over NATS: ğŸ”§ NATS Configuration Details<br/>ğŸŒ URLs: ["nats://localhost:4443"]<br/>ğŸ”’ TLS: enabled (mTLS)<br/>ğŸ“œ CA: tests/certs/ca.pem<br/>ğŸ”‘ Cert: tests/certs/client-cert.pem<br/>ğŸ—ï¸ Key: tests/certs/client-key.pem<br/>â±ï¸ Connection Timeout: 5s<br/>ğŸ”„ Reconnect Timeout: 2s<br/>ğŸ” Max Reconnects: 5<br/>ğŸ“¨ Max Pending: 512<br/>â²ï¸ Request Timeout: 30s
    end

    %% Subject Mapping
    rect rgb(26, 26, 26)
        note over LogAgent, HealthMon: ğŸ“ NATS Subject Mapping<br/>ğŸ”— Registration: "qollective.a2a.v1.register"<br/>âŒ Deregistration: "qollective.a2a.v1.deregister"<br/>ğŸ’“ Heartbeat: "qollective.a2a.v1.heartbeat"<br/>ğŸ” Discovery: "qollective.a2a.v1.discover"<br/>ğŸ¯ Capabilities: "qollective.a2a.v1.capabilities"<br/>ğŸ’— Health: "qollective.a2a.v1.health"<br/>ğŸ“¢ Announce: "qollective.a2a.v1.registry.announce"<br/>ğŸ‰ Events: "qollective.a2a.v1.registry.events"
    end