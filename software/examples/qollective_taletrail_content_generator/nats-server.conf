# TaleTrail NATS Server - Secured with NKey Authentication
# Subject-level authorization enforces principle of least privilege

# Port Configuration
port: 5222

# TLS Configuration for Client Connections
tls {
  cert_file: "/certs/server-cert.pem"
  key_file: "/certs/server-key.pem"
  ca_file: "/certs/ca.pem"
  verify: false          # Don't require client certificates
  verify_and_map: false  # Don't map client certificates to users
  timeout: 5
}

# HTTPS Monitoring (TLS-enabled)
https_port: 8222

# JetStream Configuration
jetstream {
  store_dir: /data
  max_memory_store: 1GB
  max_file_store: 10GB
}

# TODO: Re-enable authorization after adding NKey support to Qollective
# NKey Authorization with Subject-Level Permissions (DISABLED FOR TESTING)
#authorization {
#  users: [
#    # Test Client - broad permissions for integration testing
#    {
#      user: "test"
#      password: "test"
#      permissions: {
#        publish: {
#          allow: [">"]
#        }
#        subscribe: {
#          allow: [">"]
#        }
#      }
#    },
#
#    # Story Generator - can publish stories and events, subscribe to requests
#    {
#      nkey: "UCJEP5KGIXBBEN2TC365DHJJODBRJ2R6DFB5K2FLYGH2DC7SKJNRZRAZ"
#      permissions: {
#        publish: {
#          allow: ["mcp.story.response.>", "mcp.events.story.>"]
#        }
#        subscribe: {
#          allow: ["mcp.story.generate", "mcp.orchestrator.story.>"]
#        }
#      }
#    },
#
#    # Quality Control - can publish validation results and events
#    {
#      nkey: "UBUWNQX6ZXTB7CN7Z4J5BN7VGD7AWFWS3POG5ID6RCB4UMDKBOS732HU"
#      permissions: {
#        publish: {
#          allow: ["mcp.quality.response.>", "mcp.events.quality.>"]
#        }
#        subscribe: {
#          allow: ["mcp.quality.validate", "mcp.orchestrator.quality.>"]
#        }
#      }
#    },
#
#    # Constraint Enforcer - can publish constraint results and events
#    {
#      nkey: "UC7AUWB4CWQ3EA6LSABUJNVQVLKOAM6FIS3LQDXXUOXNWF26MC6ZDKEH"
#      permissions: {
#        publish: {
#          allow: ["mcp.constraint.response.>", "mcp.events.constraint.>"]
#        }
#        subscribe: {
#          allow: ["mcp.constraint.enforce", "mcp.orchestrator.constraint.>"]
#        }
#      }
#    },
#
#    # Prompt Helper - can publish prompt optimization results and events
#    {
#      nkey: "UBK2T2YDMQQRQFVBAWWPAFIPZRDVCSP5YLJYCQ2YEM7TAE526RDZD3Z5"
#      permissions: {
#        publish: {
#          allow: ["mcp.prompt.response.>", "mcp.events.prompt.>"]
#        }
#        subscribe: {
#          allow: ["mcp.prompt.helper", "mcp.orchestrator.prompt.>"]
#        }
#      }
#    },
#
#    # Orchestrator - full coordination access
#    {
#      nkey: "UAGKWEU3MHNMWQPWYP5GBQMTCQHA7Q5PZR3ZPQPNERJTV7T76MTAWJH3"
#      permissions: {
#        publish: {
#          allow: ["mcp.orchestrator.>", "mcp.story.>", "mcp.quality.>", "mcp.constraint.>", "mcp.prompt.>"]
#        }
#        subscribe: {
#          allow: ["mcp.events.>", "mcp.*.response.>"]
#        }
#      }
#    },
#
#    # Gateway - can send orchestrator requests, subscribe to events
#    {
#      nkey: "UDIASFZD7AZIM6HMD3DN2NYMKI3LAGL2JPJI3PYZILVA4L2AWFLWAMJX"
#      permissions: {
#        publish: {
#          allow: ["mcp.orchestrator.request", "mcp.gateway.>"]
#        }
#        subscribe: {
#          allow: ["mcp.events.>", "mcp.orchestrator.response.>"]
#        }
#      }
#    }
#  ]
#}

# Logging
debug: false
trace: false
logtime: true
log_file: "/data/nats-server.log"
