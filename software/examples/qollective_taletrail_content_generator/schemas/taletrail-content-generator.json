{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://schemas.qollective.io/taletrail/content-generator/v1.0.0",
  "title": "TaleTrail Content Generator Schema",
  "description": "Complete schema for TaleTrail AI content generation system with envelope-first architecture",
  "version": "1.0.0",

  "$defs": {
    "AgeGroup": {
      "type": "string",
      "enum": ["6-8", "9-11", "12-14", "15-17", "+18"],
      "description": "Target age group for content generation"
    },

    "Language": {
      "type": "string",
      "enum": ["de", "en"],
      "description": "Content language: de (German), en (English)"
    },

    "VocabularyLevel": {
      "type": "string",
      "enum": ["basic", "intermediate", "advanced"],
      "description": "Vocabulary complexity level"
    },

    "GenerationStatus": {
      "type": "string",
      "enum": ["pending", "in_progress", "completed", "failed"],
      "description": "Status of content generation"
    },

    "TrailStatus": {
      "type": "string",
      "enum": ["DRAFT", "PUBLISHED", "ARCHIVED"],
      "description": "Publication status of trail (matches DB enum)"
    },

    "CorrectionCapability": {
      "type": "string",
      "enum": ["CanFixLocally", "NeedsRevision", "NoFixPossible"],
      "description": "Validation service correction capability"
    },

    "GenerationPhase": {
      "type": "string",
      "enum": ["PromptGeneration", "Structure", "Generation", "Validation", "Assembly", "Complete"],
      "description": "Current phase of generation pipeline"
    },

    "MCPServiceType": {
      "type": "string",
      "enum": ["StoryGenerator", "QualityControl", "ConstraintEnforcer", "PromptHelper", "Orchestrator"],
      "description": "MCP service identifier"
    },

    "PromptGenerationMethod": {
      "type": "string",
      "enum": ["LLMGenerated", "TemplateFallback", "Cached"],
      "description": "Method used to generate prompts"
    },

    "RestrictedWordsMergeMode": {
      "type": "string",
      "enum": ["Replace", "Merge", "ConfigOnly"],
      "default": "Merge",
      "description": "How to merge custom restricted words with config defaults"
    },

    "ValidationPolicy": {
      "type": "object",
      "properties": {
        "enable_validation": {
          "type": "boolean",
          "default": true,
          "description": "Whether to enable content validation"
        },
        "custom_restricted_words": {
          "type": "object",
          "additionalProperties": {
            "type": "array",
            "items": { "type": "string" }
          },
          "description": "Custom restricted words per language (overrides or merges with config defaults)"
        },
        "merge_mode": {
          "$ref": "#/$defs/RestrictedWordsMergeMode",
          "description": "How to handle custom_restricted_words vs config defaults"
        }
      },
      "description": "Validation policy for content generation"
    },

    "ApiVersion": {
      "type": "string",
      "enum": ["v1"],
      "description": "External API version"
    },

    "ExternalGenerationRequestV1": {
      "type": "object",
      "required": ["theme", "age_group", "language"],
      "properties": {
        "theme": {
          "type": "string",
          "minLength": 5,
          "maxLength": 200,
          "description": "Story theme (e.g., 'underwater adventure')"
        },
        "age_group": {
          "$ref": "#/$defs/AgeGroup"
        },
        "language": {
          "$ref": "#/$defs/Language"
        }
      },
      "additionalProperties": false
    },

    "TrailInsertData": {
      "type": "object",
      "required": ["title", "metadata", "status", "is_public"],
      "properties": {
        "title": {
          "type": "string",
          "minLength": 5,
          "maxLength": 255,
          "description": "Trail title"
        },
        "description": {
          "type": "string",
          "maxLength": 2000,
          "description": "Trail description"
        },
        "metadata": {
          "type": "object",
          "description": "Trail metadata JSON (generation params, word count, etc.)"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string",
            "maxLength": 50
          },
          "maxItems": 20,
          "description": "Categorization tags"
        },
        "status": {
          "$ref": "#/$defs/TrailStatus"
        },
        "is_public": {
          "type": "boolean",
          "description": "Public visibility"
        },
        "price_coins": {
          "type": ["integer", "null"],
          "description": "Price in coins (null for free content)"
        }
      }
    },

    "TrailStepInsertData": {
      "type": "object",
      "required": ["step_order", "metadata", "content_data", "is_required"],
      "properties": {
        "step_order": {
          "type": "integer",
          "minimum": 1,
          "description": "Sequential order of step"
        },
        "title": {
          "type": "string",
          "maxLength": 255,
          "description": "Step title"
        },
        "description": {
          "type": "string",
          "maxLength": 1000,
          "description": "Step description"
        },
        "metadata": {
          "type": "object",
          "description": "Step metadata (word count, node_id, convergence point, etc.)"
        },
        "content_data": {
          "type": "object",
          "description": "Interactive story node content"
        },
        "is_required": {
          "type": "boolean",
          "description": "Whether step is required"
        }
      }
    },

    "ExternalGenerationResponseV1": {
      "type": "object",
      "required": ["job_id", "status", "metadata"],
      "properties": {
        "job_id": {
          "type": "string",
          "format": "uuid",
          "description": "Job identifier for tracking"
        },
        "status": {
          "type": "string",
          "enum": ["completed", "failed"],
          "description": "Final job status"
        },
        "trail_data": {
          "$ref": "#/$defs/TrailInsertData",
          "description": "Trail structure ready for DB insert (if completed)"
        },
        "trail_steps_data": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/TrailStepInsertData"
          },
          "description": "Trail steps ready for DB insert (if completed)"
        },
        "error": {
          "$ref": "#/$defs/ExternalError",
          "description": "Error details (if failed)"
        },
        "metadata": {
          "type": "object",
          "description": "Generation statistics and metadata"
        }
      }
    },

    "ExternalJobStatus": {
      "type": "object",
      "required": ["job_id", "status", "progress_percentage"],
      "properties": {
        "job_id": {
          "type": "string",
          "format": "uuid"
        },
        "status": {
          "type": "string",
          "enum": ["pending", "in_progress", "completed", "failed"]
        },
        "progress_percentage": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100
        },
        "current_phase": {
          "type": "string",
          "description": "Human-readable phase description"
        },
        "estimated_completion_seconds": {
          "type": "integer",
          "description": "Estimated time to completion"
        }
      }
    },

    "ExternalError": {
      "type": "object",
      "required": ["error_code", "error_message"],
      "properties": {
        "error_code": {
          "type": "string"
        },
        "error_message": {
          "type": "string"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "retry_possible": {
          "type": "boolean"
        }
      }
    },

    "GenerationRequest": {
      "type": "object",
      "required": ["theme", "age_group", "language", "tenant_id"],
      "properties": {
        "theme": {
          "type": "string",
          "minLength": 5,
          "maxLength": 200
        },
        "age_group": {
          "$ref": "#/$defs/AgeGroup"
        },
        "language": {
          "$ref": "#/$defs/Language"
        },
        "educational_goals": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "maxItems": 10,
          "default": []
        },
        "node_count": {
          "type": "integer",
          "minimum": 8,
          "maximum": 32,
          "default": 16,
          "description": "Must be even number for convergence calculation"
        },
        "vocabulary_level": {
          "$ref": "#/$defs/VocabularyLevel",
          "default": "basic"
        },
        "required_elements": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "maxItems": 5,
          "default": []
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string",
            "maxLength": 50
          },
          "maxItems": 20,
          "default": []
        },
        "author_id": {
          "type": ["integer", "null"],
          "description": "TaleTrails user ID from JWT"
        },
        "tenant_id": {
          "type": "integer",
          "description": "TaleTrails tenant ID (extracted by Qollective)"
        },
        "prompt_packages": {
          "type": ["object", "null"],
          "description": "Cached prompts from prompt-helper (Phase 0.5)"
        },
        "story_structure": {
          "type": "string",
          "enum": ["guided", "adventure", "epic", "choose_your_path"],
          "description": "Predefined story structure preset (Tier 1: Simple). Mutually exclusive with dag_config. Takes priority if both provided"
        },
        "dag_config": {
          "$ref": "#/$defs/DagStructureConfig",
          "description": "Custom DAG configuration (Tier 2: Advanced). Mutually exclusive with story_structure"
        },
        "validation_policy": {
          "$ref": "#/$defs/ValidationPolicy",
          "description": "Validation policy for content generation (optional)"
        }
      }
    },

    "GenerationResponse": {
      "type": "object",
      "required": ["request_id", "status", "progress_percentage"],
      "properties": {
        "request_id": {
          "type": "string",
          "format": "uuid"
        },
        "status": {
          "$ref": "#/$defs/GenerationStatus"
        },
        "progress_percentage": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100
        },
        "trail": {
          "$ref": "#/$defs/Trail"
        },
        "trail_steps": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/TrailStep"
          }
        },
        "generation_metadata": {
          "$ref": "#/$defs/GenerationMetadata"
        },
        "prompt_generation_metadata": {
          "$ref": "#/$defs/PromptGenerationSummary"
        },
        "execution_trace": {
          "$ref": "#/$defs/PipelineExecutionTrace",
          "description": "Complete execution trace with all service invocations and timing"
        },
        "errors": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/GenerationError"
          }
        }
      }
    },

    "Trail": {
      "type": "object",
      "required": ["title", "metadata", "status", "is_public"],
      "properties": {
        "title": {
          "type": "string",
          "minLength": 5,
          "maxLength": 255
        },
        "description": {
          "type": "string",
          "maxLength": 2000
        },
        "metadata": {
          "type": "object",
          "description": "Generated metadata: generation_params, word_count, ai_model, etc."
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "status": {
          "$ref": "#/$defs/TrailStatus"
        },
        "category": {
          "type": "string",
          "const": "story"
        },
        "is_public": {
          "type": "boolean"
        },
        "price_coins": {
          "type": ["integer", "null"]
        }
      }
    },

    "TrailStep": {
      "type": "object",
      "required": ["step_order", "metadata", "content_reference", "is_required"],
      "properties": {
        "step_order": {
          "type": "integer",
          "minimum": 1
        },
        "title": {
          "type": "string",
          "maxLength": 255
        },
        "description": {
          "type": "string",
          "maxLength": 1000
        },
        "metadata": {
          "type": "object",
          "description": "word_count, node_id, convergence_point, etc."
        },
        "content_reference": {
          "$ref": "#/$defs/ContentReference"
        },
        "is_required": {
          "type": "boolean"
        }
      }
    },

    "ContentReference": {
      "type": "object",
      "required": ["temp_node_id", "content"],
      "properties": {
        "temp_node_id": {
          "type": "string",
          "format": "uuid"
        },
        "content": {
          "$ref": "#/$defs/Content"
        }
      }
    },

    "Content": {
      "type": "object",
      "required": ["type", "node_id", "text", "choices", "convergence_point", "next_nodes"],
      "properties": {
        "type": {
          "type": "string",
          "const": "interactive_story_node"
        },
        "node_id": {
          "type": "string",
          "format": "uuid"
        },
        "text": {
          "type": "string",
          "minLength": 50,
          "maxLength": 1000
        },
        "choices": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/Choice"
          },
          "minItems": 1,
          "maxItems": 4
        },
        "convergence_point": {
          "type": "boolean"
        },
        "next_nodes": {
          "type": "array",
          "items": {
            "type": "string",
            "format": "uuid"
          }
        },
        "educational_content": {
          "$ref": "#/$defs/EducationalContent"
        }
      }
    },

    "Choice": {
      "type": "object",
      "required": ["id", "text", "next_node_id"],
      "properties": {
        "id": {
          "type": "string",
          "format": "uuid"
        },
        "text": {
          "type": "string",
          "minLength": 10,
          "maxLength": 200
        },
        "next_node_id": {
          "type": "string",
          "format": "uuid"
        },
        "metadata": {
          "type": "object"
        }
      }
    },

    "DAG": {
      "type": "object",
      "required": ["nodes", "edges", "start_node_id", "convergence_points"],
      "properties": {
        "nodes": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/$defs/ContentNode"
          }
        },
        "edges": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/Edge"
          }
        },
        "start_node_id": {
          "type": "string",
          "format": "uuid"
        },
        "convergence_points": {
          "type": "array",
          "items": {
            "type": "string",
            "format": "uuid"
          }
        }
      }
    },

    "ContentNode": {
      "type": "object",
      "required": ["id", "content", "incoming_edges", "outgoing_edges"],
      "properties": {
        "id": {
          "type": "string",
          "format": "uuid"
        },
        "content": {
          "$ref": "#/$defs/Content"
        },
        "incoming_edges": {
          "type": "integer",
          "minimum": 0
        },
        "outgoing_edges": {
          "type": "integer",
          "minimum": 0
        },
        "generation_metadata": {
          "type": "object"
        }
      }
    },

    "Edge": {
      "type": "object",
      "required": ["from_node_id", "to_node_id", "choice_id"],
      "properties": {
        "from_node_id": {
          "type": "string",
          "format": "uuid"
        },
        "to_node_id": {
          "type": "string",
          "format": "uuid"
        },
        "choice_id": {
          "type": "string",
          "format": "uuid"
        },
        "weight": {
          "type": "number"
        }
      }
    },

    "ValidationResult": {
      "type": "object",
      "required": ["is_valid", "age_appropriate_score", "safety_issues", "educational_value_score", "corrections", "correction_capability"],
      "properties": {
        "is_valid": {
          "type": "boolean"
        },
        "age_appropriate_score": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0
        },
        "safety_issues": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "educational_value_score": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0
        },
        "corrections": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/CorrectionSuggestion"
          }
        },
        "correction_capability": {
          "$ref": "#/$defs/CorrectionCapability"
        }
      }
    },

    "ConstraintResult": {
      "type": "object",
      "required": ["vocabulary_violations", "theme_consistency_score", "required_elements_present", "missing_elements", "corrections", "correction_capability"],
      "properties": {
        "vocabulary_violations": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/VocabularyViolation"
          }
        },
        "theme_consistency_score": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0
        },
        "required_elements_present": {
          "type": "boolean"
        },
        "missing_elements": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "corrections": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/CorrectionSuggestion"
          }
        },
        "correction_capability": {
          "$ref": "#/$defs/CorrectionCapability"
        }
      }
    },

    "CorrectionSuggestion": {
      "type": "object",
      "required": ["field", "issue", "suggestion", "severity"],
      "properties": {
        "field": {
          "type": "string"
        },
        "issue": {
          "type": "string"
        },
        "suggestion": {
          "type": "string"
        },
        "severity": {
          "type": "string",
          "enum": ["low", "medium", "high"]
        }
      }
    },

    "VocabularyViolation": {
      "type": "object",
      "required": ["word", "node_id", "current_level", "target_level", "suggestions"],
      "properties": {
        "word": {
          "type": "string"
        },
        "node_id": {
          "type": "string",
          "format": "uuid"
        },
        "current_level": {
          "$ref": "#/$defs/VocabularyLevel"
        },
        "target_level": {
          "$ref": "#/$defs/VocabularyLevel"
        },
        "suggestions": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },

    "EducationalContent": {
      "type": "object",
      "properties": {
        "topic": {
          "type": "string"
        },
        "learning_objective": {
          "type": "string"
        },
        "vocabulary_words": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "maxItems": 20
        },
        "educational_facts": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },

    "CorrectionSummary": {
      "type": "object",
      "required": ["node_id", "correction_type", "success", "attempts"],
      "properties": {
        "node_id": {
          "type": "string",
          "description": "ID of node that was corrected"
        },
        "correction_type": {
          "type": "string",
          "enum": ["LocalFix", "Regenerate", "Skip"],
          "description": "Type of correction applied"
        },
        "success": {
          "type": "boolean",
          "description": "Whether the correction succeeded"
        },
        "attempts": {
          "type": "integer",
          "minimum": 1,
          "description": "Number of attempts to correct this node"
        }
      }
    },

    "ValidationIssueSummary": {
      "type": "object",
      "required": ["node_id", "severity", "issue_type", "description"],
      "properties": {
        "node_id": {
          "type": "string",
          "description": "ID of node with unresolved issue"
        },
        "severity": {
          "type": "string",
          "enum": ["Critical", "Warning", "Info"],
          "description": "Issue severity level"
        },
        "issue_type": {
          "type": "string",
          "description": "Type of validation issue (e.g., 'age_appropriateness', 'word_count')"
        },
        "description": {
          "type": "string",
          "description": "Human-readable issue description"
        }
      }
    },

    "GenerationMetadata": {
      "type": "object",
      "required": ["generated_at", "total_word_count", "ai_model_version", "generation_duration_seconds", "validation_rounds", "orchestrator_version", "validation_pass_rate", "negotiation_rounds_executed", "resolved_node_count"],
      "properties": {
        "generated_at": {
          "type": "string",
          "format": "date-time"
        },
        "total_word_count": {
          "type": "integer"
        },
        "ai_model_version": {
          "type": "string"
        },
        "generation_duration_seconds": {
          "type": "integer"
        },
        "validation_rounds": {
          "type": "integer",
          "description": "Total number of validation rounds executed (includes initial + negotiation rounds)"
        },
        "orchestrator_version": {
          "type": "string"
        },
        "validation_pass_rate": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Percentage of nodes that passed validation (nodes_passed / total_nodes)"
        },
        "negotiation_rounds_executed": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of negotiation rounds executed after initial validation"
        },
        "resolved_node_count": {
          "type": "integer",
          "description": "Actual node count used after resolving preset/explicit values (Priority: explicit > preset > defaults)"
        },
        "corrections_applied": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/CorrectionSummary"
          },
          "description": "List of all correction attempts during negotiation"
        },
        "unresolved_validation_issues": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/ValidationIssueSummary"
          },
          "description": "Issues remaining after max negotiation rounds exceeded (empty if all resolved)"
        }
      }
    },

    "GenerationError": {
      "type": "object",
      "required": ["error_code", "error_message", "timestamp", "retry_possible"],
      "properties": {
        "error_code": {
          "type": "string"
        },
        "error_message": {
          "type": "string"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "retry_possible": {
          "type": "boolean"
        }
      }
    },

    "PromptPackage": {
      "type": "object",
      "required": ["system_prompt", "user_prompt", "language", "llm_model", "llm_config", "prompt_metadata", "fallback_used"],
      "properties": {
        "system_prompt": {
          "type": "string",
          "description": "LLM system instruction"
        },
        "user_prompt": {
          "type": "string",
          "description": "LLM user message with context"
        },
        "language": {
          "$ref": "#/$defs/Language"
        },
        "llm_model": {
          "type": "string",
          "description": "LLM model identifier"
        },
        "llm_config": {
          "$ref": "#/$defs/LLMConfig"
        },
        "prompt_metadata": {
          "$ref": "#/$defs/PromptMetadata"
        },
        "fallback_used": {
          "type": "boolean"
        }
      }
    },

    "LLMConfig": {
      "type": "object",
      "required": ["temperature", "max_tokens", "top_p", "frequency_penalty", "presence_penalty", "stop_sequences"],
      "properties": {
        "temperature": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 2.0,
          "default": 0.7
        },
        "max_tokens": {
          "type": "integer",
          "minimum": 1,
          "maximum": 32000,
          "default": 2000
        },
        "top_p": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "default": 0.9
        },
        "frequency_penalty": {
          "type": "number",
          "minimum": -2.0,
          "maximum": 2.0,
          "default": 0.0
        },
        "presence_penalty": {
          "type": "number",
          "minimum": -2.0,
          "maximum": 2.0,
          "default": 0.0
        },
        "stop_sequences": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "default": []
        }
      }
    },

    "PromptMetadata": {
      "type": "object",
      "required": ["generated_at", "template_version", "generation_method", "age_group_context", "language_context", "service_target", "theme_context"],
      "properties": {
        "generated_at": {
          "type": "string",
          "format": "date-time"
        },
        "template_version": {
          "type": "string"
        },
        "generation_method": {
          "$ref": "#/$defs/PromptGenerationMethod"
        },
        "age_group_context": {
          "$ref": "#/$defs/AgeGroup"
        },
        "language_context": {
          "$ref": "#/$defs/Language"
        },
        "service_target": {
          "$ref": "#/$defs/MCPServiceType"
        },
        "theme_context": {
          "type": "string"
        }
      }
    },

    "PromptGenerationRequest": {
      "type": "object",
      "required": ["generation_request", "service_target"],
      "properties": {
        "generation_request": {
          "$ref": "#/$defs/GenerationRequest"
        },
        "service_target": {
          "$ref": "#/$defs/MCPServiceType"
        },
        "node_context": {
          "$ref": "#/$defs/NodeContext"
        },
        "batch_info": {
          "$ref": "#/$defs/BatchInfo"
        }
      }
    },

    "NodeContext": {
      "type": "object",
      "required": ["node_id", "node_position", "is_convergence_point", "incoming_edges"],
      "properties": {
        "node_id": {
          "type": "string",
          "format": "uuid"
        },
        "node_position": {
          "type": "integer",
          "minimum": 1
        },
        "is_convergence_point": {
          "type": "boolean"
        },
        "incoming_edges": {
          "type": "integer",
          "minimum": 0
        },
        "previous_content": {
          "type": "string"
        }
      }
    },

    "BatchInfo": {
      "type": "object",
      "required": ["batch_id", "batch_size", "batch_index", "total_batches"],
      "properties": {
        "batch_id": {
          "type": "string",
          "format": "uuid"
        },
        "batch_size": {
          "type": "integer",
          "minimum": 1
        },
        "batch_index": {
          "type": "integer",
          "minimum": 0
        },
        "total_batches": {
          "type": "integer",
          "minimum": 1
        }
      }
    },

    "PromptGenerationSummary": {
      "type": "object",
      "required": ["prompts_generated_at", "prompt_generation_duration_ms", "prompts_used", "fallback_count", "llm_generated_count"],
      "properties": {
        "prompts_generated_at": {
          "type": "string",
          "format": "date-time"
        },
        "prompt_generation_duration_ms": {
          "type": "integer"
        },
        "prompts_used": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/$defs/PromptPackage"
          }
        },
        "fallback_count": {
          "type": "integer"
        },
        "llm_generated_count": {
          "type": "integer"
        }
      }
    },

    "GatewayMappingConfig": {
      "type": "object",
      "required": ["defaults", "validation"],
      "properties": {
        "defaults": {
          "$ref": "#/$defs/MappingDefaults"
        },
        "validation": {
          "$ref": "#/$defs/MappingValidation"
        }
      }
    },

    "MappingDefaults": {
      "type": "object",
      "properties": {
        "node_count_6_8": {
          "type": "integer",
          "default": 8
        },
        "node_count_9_11": {
          "type": "integer",
          "default": 12
        },
        "node_count_12_14": {
          "type": "integer",
          "default": 16
        },
        "node_count_15_17": {
          "type": "integer",
          "default": 20
        },
        "node_count_18_plus": {
          "type": "integer",
          "default": 24
        },
        "vocabulary_level_6_8": {
          "type": "string",
          "default": "basic"
        },
        "vocabulary_level_9_11": {
          "type": "string",
          "default": "basic"
        },
        "vocabulary_level_12_14": {
          "type": "string",
          "default": "intermediate"
        },
        "vocabulary_level_15_17": {
          "type": "string",
          "default": "intermediate"
        },
        "vocabulary_level_18_plus": {
          "type": "string",
          "default": "advanced"
        },
        "educational_goals": {
          "type": "object",
          "additionalProperties": {
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        },
        "required_elements": {
          "type": "object",
          "additionalProperties": {
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        }
      }
    },

    "MappingValidation": {
      "type": "object",
      "properties": {
        "max_theme_length": {
          "type": "integer",
          "default": 200
        },
        "min_theme_length": {
          "type": "integer",
          "default": 5
        },
        "allowed_languages": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "default": ["de", "en"]
        },
        "allowed_age_groups": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "default": ["6-8", "9-11", "12-14", "15-17", "+18"]
        }
      }
    },

    "MappingError": {
      "type": "object",
      "required": ["error_type", "message"],
      "properties": {
        "error_type": {
          "type": "string",
          "enum": ["ValidationError", "ConfigurationError", "InternalResponseError", "FormatConversionError"]
        },
        "message": {
          "type": "string"
        }
      }
    },

    "TaleTrailCustomMetadata": {
      "type": "object",
      "description": "Custom metadata extensions for TaleTrail content generation (stored in Meta.extensions)",
      "properties": {
        "generation_phase": {
          "$ref": "#/$defs/GenerationPhase",
          "description": "Current phase of the generation pipeline"
        },
        "batch_id": {
          "type": "string",
          "format": "uuid",
          "description": "Batch identifier for grouping related generation operations"
        },
        "correlation_id": {
          "type": "string",
          "format": "uuid",
          "description": "Correlation ID for tracking request chains across services"
        }
      }
    },

    "ConvergencePattern": {
      "type": "string",
      "enum": ["SingleConvergence", "MultipleConvergence", "EndOnly", "PureBranching", "ParallelPaths"],
      "description": "Pattern for how story branches converge"
    },

    "DagStructureConfig": {
      "type": "object",
      "required": ["node_count", "convergence_pattern", "max_depth", "branching_factor"],
      "properties": {
        "node_count": {
          "type": "integer",
          "minimum": 4,
          "maximum": 100,
          "description": "Total number of nodes in story DAG"
        },
        "convergence_pattern": {
          "$ref": "#/$defs/ConvergencePattern"
        },
        "convergence_point_ratio": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Position of convergence as ratio (0.5 = midpoint). Required for SingleConvergence, MultipleConvergence, and EndOnly. Must be omitted for PureBranching and ParallelPaths"
        },
        "max_depth": {
          "type": "integer",
          "minimum": 3,
          "maximum": 20,
          "description": "Maximum depth of DAG tree"
        },
        "branching_factor": {
          "type": "integer",
          "minimum": 2,
          "maximum": 4,
          "description": "Number of choices per decision node"
        }
      }
    },

    "ServiceInvocation": {
      "type": "object",
      "required": ["service_name", "tool_name", "started_at", "duration_ms", "success", "phase"],
      "properties": {
        "service_name": {
          "type": "string",
          "description": "MCP service name (prompt-helper, story-generator, quality-control, constraint-enforcer)"
        },
        "tool_name": {
          "type": "string",
          "description": "MCP tool invoked (generate_structure, validate_content, etc.)"
        },
        "started_at": {
          "type": "string",
          "format": "date-time",
          "description": "When the service call started"
        },
        "duration_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Duration of service call in milliseconds"
        },
        "success": {
          "type": "boolean",
          "description": "Whether the service call succeeded"
        },
        "error_message": {
          "type": "string",
          "description": "Error message if service call failed"
        },
        "phase": {
          "$ref": "#/$defs/GenerationPhase",
          "description": "Pipeline phase during which this service was invoked"
        },
        "node_id": {
          "type": "string",
          "format": "uuid",
          "description": "Node ID being processed (for content generation and validation)"
        },
        "batch_id": {
          "type": "integer",
          "description": "Batch ID if part of batch processing"
        }
      }
    },

    "PipelineExecutionTrace": {
      "type": "object",
      "required": ["request_id", "total_duration_ms", "phases_completed", "service_invocations"],
      "properties": {
        "request_id": {
          "type": "string",
          "format": "uuid",
          "description": "Request ID for this execution"
        },
        "total_duration_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Total pipeline execution time in milliseconds"
        },
        "phases_completed": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/GenerationPhase"
          },
          "description": "List of pipeline phases completed in order"
        },
        "service_invocations": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/ServiceInvocation"
          },
          "description": "Complete history of all MCP service calls with timing"
        },
        "events_published": {
          "type": "array",
          "items": {
            "type": "object"
          },
          "description": "All pipeline events published to NATS (optional, for debugging)"
        }
      }
    }
  },

  "qollective": {
    "version": "1.0.0",
    "envelope": {
      "enabled": true,
      "meta_sections": {
        "security": true,
        "tracing": true,
        "performance": true,
        "monitoring": true,
        "debug": false
      }
    },
    "generation": {
      "targets": ["rust-rest", "rust-nats", "rust-mcp"],
      "outputDir": "./shared-types/src/generated",
      "features": [
        "tenant-extraction",
        "validation",
        "tls",
        "mcp-client",
        "mcp-server",
        "nats",
        "rest-server"
      ]
    },
    "tenant_extraction": {
      "enabled": true,
      "jwt_extraction": {
        "tenant_claim": "tenant_id",
        "user_claim": "sub",
        "permissions_claim": "permissions"
      }
    },
    "validation": {
      "enabled": true,
      "strict_mode": true
    }
  }
}
