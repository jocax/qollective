# TaleTrail Desktop CLI

> Terminal User Interface (TUI) for testing MCP servers, browsing story trails, and monitoring NATS messages

[![Rust](https://img.shields.io/badge/rust-1.75%2B-orange)](https://www.rust-lang.org/)
[![Tests](https://img.shields.io/badge/tests-199%20passing-brightgreen)](https://github.com/qollective/taletrail)
[![License](https://img.shields.io/badge/license-MIT-blue)](LICENSE)

A keyboard-driven, SSH-friendly TUI application for the TaleTrail content generation system. Perfect for developers who prefer terminal-based workflows.

## Features

### MCP Testing Interface
Test Model Context Protocol (MCP) servers with intuitive keyboard controls:
- **24+ Pre-built Templates**: Ready-to-use request templates for 5 MCP servers
- **Real-time JSON Validation**: Catch errors before sending requests
- **Response Viewer**: Formatted JSON responses with metadata
- **Request History**: Track and replay previous requests
- **Tab-based Navigation**: Seamlessly switch between templates, editor, response, and history

### Trail Viewer
Browse and filter story trails generated by the TaleTrail system:
- **Multi-criteria Filtering**: Filter by age group, language, status, and tenant
- **Text Search**: Search across titles, descriptions, and themes
- **Bookmark System**: Mark favorite trails for quick access
- **Detail View**: Inspect trail metadata, story structure (DAG), and execution traces
- **Fast Navigation**: Keyboard-driven list browsing with instant feedback

### NATS Monitoring
Monitor NATS messages in real-time for debugging and troubleshooting:
- **Live Message Feed**: Subscribe to `mcp.>` and `taletrail.>` subjects
- **Advanced Filtering**: Filter by endpoint, message type, and text search
- **Connection Diagnostics**: View subscription status, message rates, and health
- **Detail Inspection**: Expand messages to see full JSON payloads
- **Auto-scroll**: Toggle automatic scrolling for latest messages
- **Circular Buffer**: Memory-efficient buffering (max 1000 messages)

### Settings Management
Configure the application to match your workflow:
- **NATS Connection**: URL, timeout, TLS certificates, NKey authentication
- **Directory Paths**: Trails, templates, and execution logs
- **UI Preferences**: Color theme (dark/light), auto-scroll, and display options
- **Real-time Validation**: Inline error messages for invalid settings
- **Persistent Storage**: Save configuration to `~/.config/taletrail-cli/config.toml`

## Installation

### Prerequisites

- **Rust 1.75+**: For modern async/await features and language improvements
- **NATS Server**: For MCP testing and message monitoring (optional for trail viewing)
- **Terminal**: 80x24 minimum, 120x40 recommended

### From Source

```bash
git clone https://github.com/qollective/taletrail.git
cd taletrail/software/examples/qollective_taletrail_content_generator/desktop-cli
cargo build --release
```

### Running

```bash
cargo run --release
```

Or use the compiled binary:

```bash
./target/release/desktop-cli
```

## Configuration

### Quick Start

Copy the example configuration and customize:

```bash
cp config.toml.example ~/.config/taletrail-cli/config.toml
```

### Configuration File Format

```toml
[nats]
url = "nats://localhost:4222"
timeout_secs = 30
tls_cert_path = "/path/to/cert.pem"  # optional
nkey_path = "/path/to/nkey.seed"     # optional

[directories]
trails_dir = "./trails"
templates_dir = "./templates"
execution_logs_dir = "./logs"
bookmarks_file = "~/.config/taletrail-cli/bookmarks.json"
history_file = "~/.config/taletrail-cli/history.json"

[ui]
color_theme = "dark"  # or "light"
auto_scroll = true
page_size = 20
```

### Environment Variable Overrides

All configuration settings can be overridden using environment variables:

```bash
# NATS Configuration
export NATS_URL="nats://production-server:4222"
export NATS_TIMEOUT_SECS=60
export NATS_TLS_CERT_PATH="/etc/ssl/nats-cert.pem"
export NATS_NKEY_PATH="/etc/ssl/nats-nkey.seed"

# Directories
export TRAILS_DIR="/data/trails"
export TEMPLATES_DIR="/data/templates"
export EXECUTION_LOGS_DIR="/var/log/taletrail"

# UI
export COLOR_THEME="light"
export AUTO_SCROLL="false"

# Run application
./target/release/desktop-cli
```

## Usage

### Main Menu

Launch the application to see the main menu:

```
┌─────────────────────────────────────┐
│    TaleTrail Desktop CLI - Menu     │
├─────────────────────────────────────┤
│  1. MCP Tester                      │
│  2. Trail Viewer                    │
│  3. NATS Monitor                    │
│  4. Story Generator (Phase 2)       │
│  5. Search (Phase 2)                │
│  6. Settings                        │
│  7. Quit                            │
└─────────────────────────────────────┘
```

**Navigation**: Use arrow keys or press number keys (1-7)

### MCP Testing Workflow

1. Press `1` to open MCP Tester
2. Browse templates with arrow keys
3. Press `Enter` to load a template
4. Edit the JSON request in the Editor tab
5. Press `Ctrl+Enter` to send the request
6. View the response in the Response tab
7. Check History tab to replay previous requests

**Keyboard Shortcuts**:
- `Tab` / `Shift+Tab`: Cycle through tabs
- `1-4`: Jump to specific tab
- `Ctrl+S`: Save request
- `Ctrl+Enter`: Send request
- `Ctrl+K`: Clear editor
- `ESC`: Back to menu

### Trail Viewer Workflow

1. Press `2` to open Trail Viewer
2. Navigate trails with arrow keys
3. Press `f` to open filter panel
4. Press `1-5` to quickly filter by age group
5. Press `/` to search trails
6. Press `Enter` to view trail details
7. Press `b` to bookmark a trail
8. Press `*` to filter to bookmarked trails only

**Keyboard Shortcuts**:
- `↑/↓`: Navigate trails
- `Enter`: View details
- `b`: Toggle bookmark
- `f`: Toggle filter panel
- `1-5`: Age group filters
- `l`: Cycle language filter
- `s`: Cycle status filter
- `/`: Search trails
- `ESC`: Back to list

### NATS Monitoring Workflow

1. Press `3` to open NATS Monitor
2. Watch messages appear in real-time
3. Press `1-5` to filter by endpoint
4. Press `r`, `e`, or `v` to filter by type (Request/Event/Response)
5. Press `s` to search messages
6. Press `Enter` to view full message details
7. Press `a` to toggle auto-scroll

**Keyboard Shortcuts**:
- `↑/↓`: Navigate messages
- `Enter`: View details
- `a`: Toggle auto-scroll
- `1-5`: Filter by endpoint
- `r/e/v`: Filter by type
- `s`: Search messages
- `x`: Clear filters
- `ESC`: Close detail view

### Settings Workflow

1. Press `6` to open Settings
2. Press `1-3` to switch between sections
3. Edit fields and observe real-time validation
4. Press `Ctrl+S` to save changes
5. Press `ESC` to exit

**Keyboard Shortcuts**:
- `1-3`: Switch sections
- `Ctrl+S`: Save settings
- `t`: Toggle theme
- `a`: Toggle auto-scroll
- `ESC`: Exit

## Keyboard Shortcuts Reference

See [docs/SHORTCUTS.md](docs/SHORTCUTS.md) for a complete keyboard shortcut reference.

## Troubleshooting

### Cannot connect to NATS

**Symptom**: "Connection refused" errors in MCP Tester or NATS Monitor

**Solution**:
1. Verify NATS server is running: `nats-server -V`
2. Check NATS URL in Settings (press `6`)
3. Test connection: `nats sub "mcp.>"`

### Templates not loading

**Symptom**: Empty template list in MCP Tester

**Solution**:
1. Verify templates directory path in Settings
2. Check templates directory contains `.json` files
3. Ensure template files follow the correct format

### Trails not displaying

**Symptom**: Empty trail list in Trail Viewer

**Solution**:
1. Verify trails directory path in Settings
2. Check trails directory contains valid trail JSON files
3. Clear filters by pressing `x` in Trail Viewer

### Application crashes on startup

**Symptom**: Application exits immediately or shows panic message

**Solution**:
1. Check `config.toml` for syntax errors
2. Delete `~/.config/taletrail-cli/config.toml` to reset to defaults
3. Verify directory paths exist and are readable
4. Check log file for detailed error messages

### Slow performance with many trails

**Symptom**: Lag when scrolling or filtering trails

**Solution**:
1. Use filters to narrow results
2. Search for specific trails instead of browsing all
3. Consider archiving old trails to a separate directory

## Performance Characteristics

The application is designed for efficiency and responsiveness:

- **Startup Time**: < 2 seconds on modern hardware
- **Trail Loading**: 1000+ trails load without lag
- **NATS Monitoring**: Handles 100+ messages/sec without lag
- **Memory Usage**: < 50MB typical, < 100MB with large datasets
- **Search**: < 50ms for 1500+ trails
- **Filtering**: < 50ms with multiple criteria
- **Navigation**: < 10ms response time

## Architecture

### Technology Stack

- **Iocraft v0.7**: React-like TUI framework for declarative UI
- **smol**: Lightweight async executor (required by Iocraft)
- **async-nats v0.37**: NATS client with TLS and NKey support
- **serde/serde_json**: JSON serialization and validation
- **toml**: Configuration file parsing
- **thiserror**: Structured error handling

### Design Patterns

- **Component-Based UI**: Reusable components composed into views
- **State Management**: `Arc<RwLock<T>>` pattern for shared state
- **Async Operations**: Background tasks for NATS subscriptions and file I/O
- **Circular Buffers**: Memory-efficient message storage
- **Event-Driven**: Reactive updates based on user input and system events

For detailed architecture documentation, see [docs/ARCHITECTURE.md](docs/ARCHITECTURE.md).

## Development

### Running Tests

```bash
cargo test --lib
```

**Test Suite**: 199 unit and integration tests with 100% pass rate

### Building for Release

```bash
cargo build --release --locked
```

### Code Quality

```bash
# Format code
cargo fmt

# Run linter
cargo clippy -- -D warnings

# Check for security vulnerabilities
cargo audit
```

## Known Limitations

- **Keyboard-only Navigation**: No mouse support (by design)
- **Minimum Terminal Size**: 80x24 (components may not render properly below this)
- **ASCII-only UI**: No Unicode box drawing characters (for compatibility)
- **Read-only Trail Viewing**: Cannot edit trails from CLI
- **Phase 2 Features**: Story Generator and Search are not yet implemented

## Roadmap

### Phase 2: Advanced Features (Planned)

- **Advanced Trail Viewer**:
  - Linear Reader mode (sequential story reading)
  - Interactive mode (navigate story choices)
  - Enhanced DAG visualization with collapsible nodes

- **Story Generation Dashboard**:
  - Submit story generation requests from CLI
  - Track generation progress in real-time
  - View results immediately upon completion

- **Search & Comparison**:
  - Global trail search with ranking
  - Side-by-side execution trace comparison
  - Diff highlighting for trail changes

- **Advanced Text Editor**:
  - Syntax highlighting for JSON and TOML
  - Multi-line selection and editing
  - Undo/redo support

### Future Enhancements

- Mouse support for hybrid keyboard/mouse workflows
- Unicode box drawing for improved visuals
- Custom color schemes and themes
- Plugin system for extensibility
- Export functionality (trails, requests, logs)

## Project Structure

```
desktop-cli/
├── src/
│   ├── main.rs              # Entry point, smol runtime
│   ├── app.rs               # Root App component
│   ├── config.rs            # Configuration management
│   ├── error.rs             # Error types
│   ├── constants.rs         # Application constants
│   ├── models/              # Data models (trail, mcp, preferences)
│   ├── nats/                # NATS client and monitoring
│   ├── utils/               # File loading, JSON validation
│   ├── state/               # State management contexts
│   ├── components/          # Reusable UI components
│   ├── views/               # Feature views (MCP, trails, monitoring, settings)
│   └── tests/               # Integration tests
├── templates/               # Symlink to MCP request templates
├── config.toml.example      # Example configuration
├── docs/                    # Documentation
│   ├── USER_GUIDE.md        # Detailed user guide
│   ├── ARCHITECTURE.md      # Technical architecture
│   └── SHORTCUTS.md         # Keyboard shortcuts reference
├── Cargo.toml               # Rust dependencies
├── CHANGELOG.md             # Release notes and version history
└── README.md                # This file
```

## Contributing

Contributions are welcome! Please see [CONTRIBUTING.md](CONTRIBUTING.md) for guidelines.

### Development Setup

1. Fork and clone the repository
2. Install Rust 1.75+
3. Run tests: `cargo test`
4. Make changes and add tests
5. Format code: `cargo fmt`
6. Run linter: `cargo clippy`
7. Submit pull request

## License

MIT License - see [LICENSE](LICENSE) for details

## Authors

Built with care by the Qollective Team

## Acknowledgments

- [Iocraft](https://github.com/ccbrown/iocraft) - Excellent TUI framework
- [async-nats](https://github.com/nats-io/nats.rs) - Robust NATS client
- [smol](https://github.com/smol-rs/smol) - Lightweight async runtime
- TaleTrail community for feedback and testing

## Related Projects

- [TaleTrail Desktop (Tauri V2)](../desktop/) - Original Electron-based desktop application
- TaleTrail MCP Servers - Model Context Protocol server implementations
- TaleTrail Documentation - Complete system documentation

## Support

- GitHub Issues: [Report bugs or request features](https://github.com/qollective/taletrail/issues)
- Documentation: [docs/](docs/)
- Community: [Discord](https://discord.gg/qollective)

## Changelog

See [CHANGELOG.md](CHANGELOG.md) for version history and release notes.

---

Made with ❤️ by Qollective | [Website](https://qollective.com) | [GitHub](https://github.com/qollective)
