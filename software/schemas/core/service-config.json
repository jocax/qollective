{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://schemas.qollective.io/core/service-config.json",
  "title": "Qollective Service Configuration Schema",
  "description": "Configuration schema for Qollective Framework services defining meta inclusion, protocol settings, and environment-specific overrides",
  "version": "1.0.0",
  "type": "object",
  "properties": {
    "service": {
      "type": "object",
      "description": "Service identity and basic configuration",
      "properties": {
        "name": {
          "type": "string",
          "description": "Service name following kebab-case convention",
          "pattern": "^[a-z][a-z0-9-]*[a-z0-9]$",
          "minLength": 2,
          "maxLength": 100,
          "examples": [
            "user-service",
            "payment-api",
            "notification-worker"
          ]
        },
        "version": {
          "type": "string",
          "description": "Service version in semantic versioning format",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "examples": [
            "1.0.0",
            "2.1.3",
            "0.5.0"
          ]
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of the service",
          "maxLength": 500,
          "examples": [
            "User management and authentication service",
            "Payment processing API"
          ]
        },
        "team": {
          "type": "string",
          "description": "Team or organization responsible for this service",
          "maxLength": 100,
          "examples": [
            "platform-team",
            "payments",
            "user-experience"
          ]
        },
        "repository": {
          "type": "string",
          "description": "Source code repository URL",
          "format": "uri",
          "examples": [
            "https://github.com/company/user-service",
            "git@github.com:company/payment-api.git"
          ]
        },
        "contact": {
          "type": "object",
          "description": "Contact information for service support",
          "properties": {
            "email": {
              "type": "string",
              "format": "email",
              "description": "Contact email for service issues"
            },
            "slack": {
              "type": "string",
              "description": "Slack channel for service support",
              "pattern": "^#[a-z0-9-]+$"
            },
            "pagerduty": {
              "type": "string",
              "description": "PagerDuty service ID for alerts"
            }
          },
          "additionalProperties": false
        }
      },
      "required": [
        "name",
        "version"
      ],
      "additionalProperties": false
    },
    "qollective": {
      "type": "object",
      "description": "Qollective Framework configuration for meta inclusion and behavior",
      "properties": {
        "tenantExtractionEnabled": {
          "type": "boolean",
          "description": "Enable tenant context extraction from JWT tokens, headers, payloads, and query parameters",
          "default": false
        },
        "meta": {
          "type": "object",
          "description": "meta section configuration controlling what information is included in envelopes",
          "properties": {
            "security": {
              "$ref": "#/$defs/metaSectionConfig",
              "description": "Security context meta configuration"
            },
            "debug": {
              "$ref": "#/$defs/metaSectionConfig",
              "description": "Debug information meta configuration"
            },
            "performance": {
              "$ref": "#/$defs/metaSectionConfig",
              "description": "Performance metrics meta configuration"
            },
            "monitoring": {
              "$ref": "#/$defs/metaSectionConfig",
              "description": "Infrastructure monitoring meta configuration"
            },
            "tracing": {
              "$ref": "#/$defs/metaSectionConfig",
              "description": "Distributed tracing meta configuration"
            },
            "extensions": {
              "type": "object",
              "description": "Custom extension sections configuration",
              "additionalProperties": {
                "$ref": "#/$defs/metaSectionConfig"
              },
              "propertyNames": {
                "pattern": "^[a-z][a-z0-9_]*[a-z0-9]$",
                "description": "Extension keys must be valid service names"
              },
              "maxProperties": 20
            }
          },
          "additionalProperties": false
        },
        "protocols": {
          "type": "object",
          "description": "Protocol-specific configuration settings",
          "properties": {
            "rest": {
              "$ref": "#/$defs/restProtocolConfig",
              "description": "REST/HTTP protocol configuration"
            },
            "grpc": {
              "$ref": "#/$defs/grpcProtocolConfig",
              "description": "gRPC protocol configuration"
            }
          },
          "additionalProperties": false
        },
        "presets": {
          "type": "object",
          "description": "Predefined configuration presets for different environments",
          "properties": {
            "development": {
              "$ref": "#/$defs/presetConfig",
              "description": "Development environment preset"
            },
            "staging": {
              "$ref": "#/$defs/presetConfig",
              "description": "Staging environment preset"
            },
            "production": {
              "$ref": "#/$defs/presetConfig",
              "description": "Production environment preset"
            },
            "high_performance": {
              "$ref": "#/$defs/presetConfig",
              "description": "High performance preset with minimal meta"
            },
            "debugging": {
              "$ref": "#/$defs/presetConfig",
              "description": "Enhanced debugging preset for production issues"
            }
          },
          "additionalProperties": {
            "$ref": "#/$defs/presetConfig"
          }
        },
        "environments": {
          "type": "object",
          "description": "Environment-specific configuration overrides",
          "additionalProperties": {
            "type": "object",
            "description": "Environment configuration inheriting from base config",
            "properties": {
              "tenantExtractionEnabled": {
                "type": "boolean",
                "description": "Override tenant extraction setting for this environment"
              },
              "meta": {
                "$ref": "#/properties/qollective/properties/meta"
              },
              "protocols": {
                "$ref": "#/properties/qollective/properties/protocols"
              },
              "preset": {
                "type": "string",
                "description": "Preset to apply for this environment",
                "examples": [
                  "development",
                  "production",
                  "high_performance"
                ]
              }
            },
            "additionalProperties": false
          }
        }
      },
      "additionalProperties": false
    }
  },
  "required": [
    "service",
    "qollective"
  ],
  "additionalProperties": false,
  "$defs": {
    "metaSectionConfig": {
      "type": "object",
      "description": "Configuration for a meta section controlling inclusion and property filtering",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Whether this meta section is enabled",
          "default": true
        },
        "properties": {
          "oneOf": [
            {
              "type": "string",
              "enum": [
                "*",
                "none"
              ],
              "description": "Include all properties (*) or no properties (none)"
            },
            {
              "type": "object",
              "description": "Fine-grained property inclusion/exclusion configuration",
              "additionalProperties": {
                "type": "boolean",
                "description": "Whether to include this specific property"
              },
              "properties": {
                "*": {
                  "type": "boolean",
                  "description": "Default inclusion setting for properties not explicitly listed"
                }
              }
            }
          ],
          "default": "*"
        },
        "sampling_rate": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Probability of including this section (0.0 to 1.0)",
          "default": 1.0,
          "examples": [
            1.0,
            0.1,
            0.01
          ]
        },
        "max_size": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum size in bytes for this meta section",
          "examples": [
            1024,
            4096,
            10240
          ]
        }
      },
      "additionalProperties": false
    },
    "restProtocolConfig": {
      "type": "object",
      "description": "REST/HTTP protocol specific configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Whether REST protocol support is enabled",
          "default": true
        },
        "headers": {
          "type": "object",
          "description": "HTTP header configuration for meta transport",
          "properties": {
            "prefix": {
              "type": "string",
              "description": "Prefix for Qollective headers",
              "pattern": "^[a-zA-Z][a-zA-Z0-9-]*$",
              "default": "X-Qollective",
              "examples": [
                "X-Qollective",
                "X-Meta",
                "Q"
              ]
            },
            "request_id": {
              "type": "string",
              "description": "Header name for request ID",
              "default": "X-Request-ID",
              "examples": [
                "X-Request-ID",
                "X-Correlation-ID"
              ]
            },
            "trace_id": {
              "type": "string",
              "description": "Header name for trace ID",
              "default": "X-Trace-ID",
              "examples": [
                "X-Trace-ID",
                "X-B3-TraceId"
              ]
            }
          },
          "additionalProperties": false
        },
        "compression": {
          "type": "object",
          "description": "Response compression configuration",
          "properties": {
            "enabled": {
              "type": "boolean",
              "description": "Whether response compression is enabled",
              "default": true
            },
            "algorithms": {
              "type": "array",
              "items": {
                "type": "string",
                "enum": [
                  "gzip",
                  "deflate",
                  "br",
                  "zstd"
                ]
              },
              "description": "Supported compression algorithms in order of preference",
              "default": [
                "gzip",
                "deflate"
              ],
              "uniqueItems": true
            },
            "min_size": {
              "type": "integer",
              "minimum": 0,
              "description": "Minimum response size in bytes to enable compression",
              "default": 1024
            }
          },
          "additionalProperties": false
        },
        "timeouts": {
          "type": "object",
          "description": "Timeout configuration for REST operations",
          "properties": {
            "request": {
              "type": "integer",
              "minimum": 1,
              "description": "Request timeout in milliseconds",
              "default": 30000,
              "examples": [
                5000,
                30000,
                60000
              ]
            },
            "connection": {
              "type": "integer",
              "minimum": 1,
              "description": "Connection timeout in milliseconds",
              "default": 5000
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "grpcProtocolConfig": {
      "type": "object",
      "description": "gRPC protocol specific configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Whether gRPC protocol support is enabled",
          "default": false
        },
        "reflection": {
          "type": "boolean",
          "description": "Whether gRPC reflection service is enabled",
          "default": false
        },
        "health_check": {
          "type": "boolean",
          "description": "Whether gRPC health check service is enabled",
          "default": true
        },
        "compression": {
          "type": "object",
          "description": "gRPC compression configuration",
          "properties": {
            "enabled": {
              "type": "boolean",
              "description": "Whether compression is enabled",
              "default": true
            },
            "algorithm": {
              "type": "string",
              "enum": [
                "gzip",
                "deflate",
                "none"
              ],
              "description": "Compression algorithm to use",
              "default": "gzip"
            }
          },
          "additionalProperties": false
        },
        "keepalive": {
          "type": "object",
          "description": "gRPC keepalive configuration",
          "properties": {
            "time": {
              "type": "integer",
              "minimum": 1,
              "description": "Keepalive time in seconds",
              "default": 30
            },
            "timeout": {
              "type": "integer",
              "minimum": 1,
              "description": "Keepalive timeout in seconds",
              "default": 5
            }
          },
          "additionalProperties": false
        },
        "max_message_size": {
          "type": "integer",
          "minimum": 1024,
          "description": "Maximum message size in bytes",
          "default": 4194304,
          "examples": [
            1048576,
            4194304,
            16777216
          ]
        }
      },
      "additionalProperties": false
    },
    "presetConfig": {
      "type": "object",
      "description": "A configuration preset defining meta and protocol settings",
      "properties": {
        "description": {
          "type": "string",
          "description": "Human-readable description of this preset",
          "maxLength": 200
        },
        "tenantExtractionEnabled": {
          "type": "boolean",
          "description": "Whether tenant extraction is enabled in this preset"
        },
        "meta": {
          "$ref": "#/properties/qollective/properties/meta"
        },
        "protocols": {
          "$ref": "#/properties/qollective/properties/protocols"
        }
      },
      "additionalProperties": false
    }
  },
  "examples": [
    {
      "service": {
        "name": "user-service",
        "version": "1.2.3",
        "description": "User management and authentication service",
        "team": "platform-team",
        "repository": "https://github.com/company/user-service",
        "contact": {
          "email": "platform-team@company.com",
          "slack": "#platform-support"
        }
      },
      "qollective": {
        "tenantExtractionEnabled": true,
        "meta": {
          "security": {
            "enabled": true,
            "properties": {
              "user_id": true,
              "session_id": true,
              "ip_address": false,
              "*": true
            }
          },
          "debug": {
            "enabled": false
          },
          "performance": {
            "enabled": true,
            "properties": "*",
            "sampling_rate": 0.1
          },
          "monitoring": {
            "enabled": true,
            "properties": {
              "server_id": true,
              "environment": true,
              "build_version": true,
              "*": false
            }
          },
          "tracing": {
            "enabled": true,
            "properties": "*"
          }
        },
        "protocols": {
          "rest": {
            "enabled": true,
            "headers": {
              "prefix": "X-User-Service"
            },
            "compression": {
              "enabled": true,
              "min_size": 512
            }
          },
          "grpc": {
            "enabled": true,
            "reflection": false,
            "health_check": true
          }
        },
        "presets": {
          "development": {
            "description": "Development environment with full meta",
            "meta": {
              "security": {
                "enabled": true,
                "properties": "*"
              },
              "debug": {
                "enabled": true,
                "properties": "*"
              },
              "performance": {
                "enabled": true,
                "properties": "*"
              },
              "monitoring": {
                "enabled": true,
                "properties": "*"
              },
              "tracing": {
                "enabled": true,
                "properties": "*"
              }
            }
          },
          "production": {
            "description": "Production environment with minimal meta",
            "tenantExtractionEnabled": true,
            "meta": {
              "security": {
                "enabled": true,
                "properties": {
                  "user_id": true,
                  "tenant_id": true,
                  "*": false
                }
              },
              "debug": {
                "enabled": false
              },
              "performance": {
                "enabled": true,
                "properties": {
                  "db_query_time": true,
                  "cache_hit_ratio": true,
                  "*": false
                },
                "sampling_rate": 0.01
              },
              "monitoring": {
                "enabled": true,
                "properties": {
                  "server_id": true,
                  "environment": true,
                  "*": false
                }
              },
              "tracing": {
                "enabled": true,
                "properties": {
                  "trace_id": true,
                  "span_id": true,
                  "*": false
                },
                "sampling_rate": 0.1
              }
            }
          }
        },
        "environments": {
          "development": {
            "preset": "development"
          },
          "staging": {
            "tenantExtractionEnabled": false,
            "meta": {
              "debug": {
                "enabled": true,
                "sampling_rate": 0.1
              }
            }
          },
          "production": {
            "preset": "production"
          }
        }
      }
    }
  ]
}
