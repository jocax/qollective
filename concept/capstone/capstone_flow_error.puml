@startuml
!theme black-knight
skinparam backgroundColor #1a1a1a
skinparam defaultFontColor #e0e0e0
skinparam sequence {
    ArrowColor #4CAF50
    ArrowFontColor #B0BEC5
    LifeLineBorderColor #757575
    LifeLineBackgroundColor #2d2d2d
    ParticipantBorderColor #4CAF50
    ParticipantBackgroundColor #263238
    ParticipantFontColor #FFFFFF
    BoxBorderColor #546E7A
    BoxBackgroundColor #1e1e1e
    GroupBorderColor #546E7A
    GroupBackgroundColor #212121
}

title **Job Recovery & Timeout Handling**

participant "Supabase\nDatabase" as Supabase #4ECDC4
participant "Edge\nFunction" as Edge #95E1D3
participant "REST\nService" as REST #F38181
participant "MCP Client\nService" as MCPClient #AA96DA
participant "Scheduled\nJob/Cron" as Cron #FFB6B9

== Scenario 1: MCP Client Service Crashes ==
REST -> MCPClient: POST /process
activate MCPClient
MCPClient --> REST: 202 Accepted
MCPClient ->x MCPClient: **CRASH**
deactivate MCPClient
note right #FF6666: Service crashes\nNo callback sent

== Scenario 2: Network Failure ==
REST -> MCPClient: POST /process
activate MCPClient
MCPClient --> REST: 202 Accepted
MCPClient -> REST: POST /callback/{jobId}
note right #FF6666: Network timeout\nCallback fails
REST -->x MCPClient: Connection timeout
deactivate MCPClient

== Scenario 3: MCP Servers Hang ==
REST -> MCPClient: POST /process
activate MCPClient
MCPClient --> REST: 202 Accepted
MCPClient -> MCPClient: Query MCP Servers
note right #FF6666: MCP Servers never respond\nInfinite wait
...Waiting indefinitely...

== Timeout Detection & Recovery ==
Cron -> Supabase: Query stale jobs\nWHERE status IN ('pending', 'processing')\nAND updated_at < NOW() - INTERVAL '5 minutes'
activate Cron
Supabase --> Cron: Return stale jobs list

alt Option 1: Mark as Failed
    Cron -> Supabase: UPDATE jobs\nSET status = 'timeout',\nerror = 'Job timed out after 5 minutes'
else Option 2: Retry Job
    Cron -> REST: POST /retry\n{jobId, attempt: 2}
    REST -> MCPClient: POST /process (retry)
else Option 3: Health Check & Recovery
    Cron -> MCPClient: GET /health/{jobId}
    alt MCP Client has result
        MCPClient --> Cron: {status: 'completed', results}
        Cron -> Supabase: Update with results
    else MCP Client has no record
        Cron -> Supabase: Mark as failed
    else MCP Client still processing
        Cron -> Cron: Wait for next cycle
    end
end
deactivate Cron

== Dead Letter Queue Pattern ==
REST -> REST: Store job in DLQ\nafter N failed callbacks
REST -> Supabase: UPDATE jobs\nSET status = 'dead_letter'
Cron -> REST: GET /dead-letter-queue
REST --> Cron: Return failed jobs
Cron -> Cron: Manual intervention\nor auto-retry logic

@enduml
